<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="../style_bootstrap.css">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/code.css">
  <link href="https://cdn.prod.website-files.com/5efdb54f07a6812bcd95cc65/6773d0fc3013e060f08d7145_favicon.jpg"
    rel="shortcut icon" type="image/x-icon">
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Day 5: Database Administration and Maintenance Concepts</title>

</head>

<body>
  <div class="copy-notification" id="copyNotification">Copied!</div>

  <div id="europeanunion-turkey">
    <img src="../static/eu.png" alt="">
  </div>
  <div id="sanayiteknolojibakan">
    <img src="../static/sanayitek.png" alt="">
  </div>
  <div id="rekabet">
    <img src="../static/rekabet.png" alt="">
  </div>
  <div id="tisk">
    <img src="../static/tisk.png" alt="">
  </div>
  <div id="undp">
    <img src="../static/undp.png" alt="">
  </div>
  <div class="content-container">
    <div class="container">
      <section>
        <h1 id="day-5-database-administration-and-practical-applications">Day 5: Database Administration and Practical
          Applications</h1>
        <h2 id="session-2-database-administration-and-maintenance-2.5-hours">Session 2: Database Administration and
          Maintenance (2.5 hours)</h2>
        <h3 id="backup-and-recovery-strategies">Backup and Recovery Strategies</h3>
        <p>Effective backup and recovery strategies are essential for protecting your data and ensuring business
          continuity. As a product owner, understanding these concepts will help you make informed decisions about data
          protection policies.</p>
        <p><strong>Types of Backups in PostgreSQL</strong>:</p>
        <ol type="1">
          <li><strong>Logical Backups</strong>: SQL statements that can recreate the database
            <ul>
              <li>Created with <code>pg_dump</code> and <code>pg_dumpall</code></li>
              <li>Human-readable and editable</li>
              <li>Can be selective (specific tables, schemas)</li>
              <li>Slower to restore for large databases</li>
            </ul>
          </li>
          <li><strong>Physical Backups</strong>: Actual data files and WAL (Write-Ahead Log) files
            <ul>
              <li>Created with file system tools or <code>pg_basebackup</code></li>
              <li>Faster for large databases</li>
              <li>Requires same PostgreSQL version for restore</li>
              <li>Basis for Point-in-Time Recovery (PITR)</li>
            </ul>
          </li>
        </ol>
      </section>
      <section>
        <p><strong>Logical Backup Tools</strong>:</p>
        <div class="sourceCode" id="cb1">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="co"># Backup a single database to a file</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="ex">pg_dump</span> dbname <span class="op">&gt;</span> backup.sql</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="co"># Backup in compressed format</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="ex">pg_dump</span> -Fc dbname <span class="op">&gt;</span> backup.dump</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="co"># Backup specific tables</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="ex">pg_dump</span> -t table1 -t table2 dbname <span class="op">&gt;</span> tables_backup.sql</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a><span class="co"># Backup a specific schema</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a><span class="ex">pg_dump</span> -n schema_name dbname <span class="op">&gt;</span> schema_backup.sql</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a><span class="co"># Backup all databases</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a><span class="ex">pg_dumpall</span> <span class="op">&gt;</span> all_dbs_backup.sql</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a><span class="co"># Backup only global objects (roles, tablespaces)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a><span class="ex">pg_dumpall</span> --globals-only <span class="op">&gt;</span> globals_backup.sql</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Restoring Logical Backups</strong>:</p>
        <div class="sourceCode" id="cb2">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="co"># Restore a plain text backup</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="ex">psql</span> dbname <span class="op">&lt;</span> backup.sql</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="co"># Restore a custom format backup</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="ex">pg_restore</span> -d dbname backup.dump</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="co"># Restore only specific tables</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="ex">pg_restore</span> -d dbname -t table1 -t table2 backup.dump</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a><span class="co"># Restore with parallelism for faster processing</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a><span class="ex">pg_restore</span> -d dbname -j 4 backup.dump</span></code></pre>
        </div>
        <p><strong>Physical Backup with pg_basebackup</strong>:</p>
        <div class="sourceCode" id="cb3">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="co"># Basic physical backup</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="ex">pg_basebackup</span> -D /backup/path -Ft -z -P</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a><span class="co"># Backup with WAL streaming</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a><span class="ex">pg_basebackup</span> -D /backup/path -Ft -z -P -X stream</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Backup Strategies</strong>:</p>
        <ol type="1">
          <li><strong>Full Backups</strong>: Complete backup of the entire database
            <ul>
              <li>Simplest to manage</li>
              <li>Requires more storage</li>
              <li>Longer backup and restore times</li>
            </ul>
          </li>
          <li><strong>Incremental Backups</strong>: Backup only what has changed
            <ul>
              <li>Implemented through WAL archiving in PostgreSQL</li>
              <li>Requires continuous WAL archiving</li>
              <li>Enables Point-in-Time Recovery</li>
            </ul>
          </li>
          <li><strong>Differential Backups</strong>: Backup changes since the last full backup
            <ul>
              <li>Not directly supported in PostgreSQL</li>
              <li>Can be implemented with custom scripts</li>
            </ul>
          </li>
        </ol>
      </section>
      <section>
        <p><strong>Backup Scheduling</strong>:</p>
        <div class="sourceCode" id="cb4">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="co"># Example crontab entries</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a><span class="co"># Daily full backup at 1 AM</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="ex">0</span> 1 * * * /usr/local/bin/pg_dump -Fc dbname <span class="op">&gt;</span> /backup/dbname_<span class="va">$(</span><span class="fu">date</span> +\%Y\%m\%d<span class="va">)</span>.dump</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="co"># Weekly full backup on Sunday at 2 AM</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="ex">0</span> 2 * * 0 /usr/local/bin/pg_dumpall <span class="op">&gt;</span> /backup/all_dbs_<span class="va">$(</span><span class="fu">date</span> +\%Y\%m\%d<span class="va">)</span>.sql</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a><span class="co"># Hourly WAL archiving check</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a><span class="ex">0</span> * * * * /path/to/check_wal_archiving.sh</span></code></pre>
        </div>
        <p><strong>Backup Validation and Testing</strong>:</p>
        <div class="sourceCode" id="cb5">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="co"># Test restore without actually restoring</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="ex">pg_restore</span> --list backup.dump</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a><span class="co"># Validate a backup file</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a><span class="ex">pg_restore</span> -l backup.dump <span class="op">&gt;</span> /dev/null</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a><span class="co"># Test restore to a temporary database</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a><span class="ex">createdb</span> test_restore</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a><span class="ex">pg_restore</span> -d test_restore backup.dump</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a><span class="co"># Run validation queries</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a><span class="ex">dropdb</span> test_restore</span></code></pre>
        </div>
      </section>
      <section>
        <h3 id="point-in-time-recovery-pitr">Point-in-Time Recovery (PITR)</h3>
        <p>Point-in-Time Recovery allows you to restore a database to any specific point in time, rather than just to
          the
          time of the last backup. This is crucial for recovering from data corruption, accidental data deletion, or
          other
          logical errors.</p>
        <p><strong>How PITR Works in PostgreSQL</strong>:</p>
        <ol type="1">
          <li><strong>Base Backup</strong>: A full physical backup of the database</li>
          <li><strong>WAL Archiving</strong>: Continuous archiving of Write-Ahead Log files</li>
          <li><strong>Recovery Process</strong>: Restore base backup, then replay WAL files up to the desired point in
            time</li>
        </ol>
      </section>
      <section>
        <p><strong>Setting Up WAL Archiving</strong>:</p>
        <ol type="1">
          <li><strong>Configure postgresql.conf</strong>:</li>
        </ol>
        <pre><code># Enable WAL archiving
wal_level = replica
archive_mode = on
archive_command = &#39;cp %p /archive/path/%f&#39;
archive_timeout = 60  # Force WAL switch every 60 seconds</code></pre>
        <ol start="2" type="1">
          <li><strong>Create Archive Directory</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb7">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="fu">mkdir</span> -p /archive/path</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="fu">chown</span> postgres:postgres /archive/path</span></code></pre>
        </div>
        <ol start="3" type="1">
          <li><strong>Restart PostgreSQL</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb8">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="ex">systemctl</span> restart postgresql</span></code></pre>
        </div>
        <p><strong>Creating a Base Backup for PITR</strong>:</p>
        <div class="sourceCode" id="cb9">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="co"># Create a base backup with WAL streaming</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a><span class="ex">pg_basebackup</span> -D /backup/base -Ft -z -P -X stream</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Performing Point-in-Time Recovery</strong>:</p>
        <ol type="1">
          <li><strong>Create recovery.conf (PostgreSQL &lt; 12) or recovery.signal (PostgreSQL ≥ 12)</strong>:</li>
        </ol>
        <p>For PostgreSQL &lt; 12:</p>
        <pre><code># recovery.conf
restore_command = &#39;cp /archive/path/%f %p&#39;
recovery_target_time = &#39;2023-04-15 14:30:00&#39;</code></pre>
        <p>For PostgreSQL ≥ 12:</p>
        <pre><code># postgresql.conf additions
restore_command = &#39;cp /archive/path/%f %p&#39;
recovery_target_time = &#39;2023-04-15 14:30:00&#39;</code></pre>
        <ol start="2" type="1">
          <li><strong>Restore Base Backup</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb12">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="co"># Stop PostgreSQL</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a><span class="ex">systemctl</span> stop postgresql</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a><span class="co"># Clear data directory</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a><span class="fu">rm</span> -rf /var/lib/postgresql/data/*</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a><span class="co"># Restore base backup</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a><span class="fu">tar</span> -xzf /backup/base/base.tar.gz -C /var/lib/postgresql/data</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a><span class="co"># For PostgreSQL ≥ 12, create recovery signal file</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a><span class="fu">touch</span> /var/lib/postgresql/data/recovery.signal</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a><span class="co"># Start PostgreSQL</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a><span class="ex">systemctl</span> start postgresql</span></code></pre>
        </div>
        <ol start="3" type="1">
          <li><strong>Monitor Recovery Process</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb13">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="co"># Check PostgreSQL logs</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a><span class="fu">tail</span> -f /var/log/postgresql/postgresql.log</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>PITR to Different Targets</strong>:</p>
        <pre><code># Recover to a specific timestamp
recovery_target_time = &#39;2023-04-15 14:30:00&#39;

# Recover to a specific transaction ID
recovery_target_xid = &#39;1234567&#39;

# Recover to a specific named restore point
recovery_target_name = &#39;before_data_load&#39;

# Recover to just before a specific error
recovery_target_lsn = &#39;16/B374D848&#39;</code></pre>
        <p><strong>Creating Named Restore Points</strong>:</p>
        <div class="sourceCode" id="cb15">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="co">-- Create a named restore point</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a><span class="kw">SELECT</span> pg_create_restore_point(<span class="st">&#39;before_major_update&#39;</span>);</span></code></pre>
        </div>
        <p><strong>Best Practices for PITR</strong>:</p>
        <ol type="1">
          <li><strong>Test Recovery Regularly</strong>: Ensure your PITR setup works by testing it periodically</li>
          <li><strong>Monitor WAL Archiving</strong>: Set up alerts for WAL archiving failures</li>
          <li><strong>Manage Archive Storage</strong>: Implement retention policies for WAL files</li>
          <li><strong>Document Recovery Procedures</strong>: Create step-by-step recovery guides</li>
          <li><strong>Automate Where Possible</strong>: Use scripts to simplify recovery processes</li>
        </ol>
      </section>
      <section>
        <p><strong>Example PITR Scenario</strong>:</p>
        <p>Imagine a scenario where a critical table was accidentally dropped at 2:45 PM:</p>
        <div class="sourceCode" id="cb16">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="co">-- Accidental drop at 2:45 PM</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a><span class="kw">DROP</span> <span class="kw">TABLE</span> important_data;</span></code></pre>
        </div>
        <p>Recovery steps:</p>
        <ol type="1">
          <li>
            <p>Identify the time just before the drop (e.g., 2:44 PM)</p>
          </li>
          <li>
            <p>Stop the application to prevent new writes</p>
          </li>
          <li>
            <p>Configure recovery to that time:</p>
            <pre><code>recovery_target_time = &#39;2023-04-15 14:44:00&#39;</code></pre>
          </li>
          <li>
            <p>Perform PITR as described above</p>
          </li>
          <li>
            <p>Verify the recovered data</p>
          </li>
          <li>
            <p>Restart the application</p>
          </li>
        </ol>
      </section>
      <section>
        <p><strong>Continuous Archiving Monitoring</strong>:</p>
        <div class="sourceCode" id="cb18">
          <pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="co">#!/bin/bash</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a><span class="co"># check_wal_archiving.sh</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a><span class="va">ARCHIVE_DIR=</span><span class="st">&quot;/archive/path&quot;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a><span class="va">THRESHOLD=</span>300  # <span class="ex">5</span> minutes</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a><span class="co"># Get the latest archived WAL file</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a><span class="va">LATEST_WAL=$(</span><span class="fu">ls</span> -t <span class="va">$ARCHIVE_DIR</span> <span class="kw">|</span> <span class="fu">head</span> -1<span class="va">)</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a><span class="kw">if</span><span class="bu"> [</span> <span class="ot">-z</span> <span class="st">&quot;</span><span class="va">$LATEST_WAL</span><span class="st">&quot;</span><span class="bu"> ]</span>; <span class="kw">then</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true"></a>    <span class="bu">echo</span> <span class="st">&quot;No WAL files found in archive directory&quot;</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true"></a>    <span class="bu">exit</span> 1</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true"></a><span class="kw">fi</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true"></a><span class="co"># Get the modification time of the latest WAL file</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true"></a><span class="va">LATEST_TIME=$(</span><span class="fu">stat</span> -c %Y <span class="va">$ARCHIVE_DIR</span>/<span class="va">$LATEST_WAL)</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true"></a><span class="va">CURRENT_TIME=$(</span><span class="fu">date</span> +%s<span class="va">)</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true"></a><span class="co"># Calculate the difference in seconds</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true"></a><span class="va">DIFF=$(($CURRENT_TIME</span> - <span class="va">$LATEST_TIME))</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true"></a><span class="kw">if</span><span class="bu"> [</span> <span class="va">$DIFF</span> <span class="ot">-gt</span> <span class="va">$THRESHOLD</span><span class="bu"> ]</span>; <span class="kw">then</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true"></a>    <span class="bu">echo</span> <span class="st">&quot;WARNING: No recent WAL files archived in the last </span><span class="va">$THRESHOLD</span><span class="st"> seconds&quot;</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true"></a>    <span class="bu">exit</span> 1</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true"></a><span class="kw">else</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true"></a>    <span class="bu">echo</span> <span class="st">&quot;WAL archiving is working properly&quot;</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true"></a>    <span class="bu">exit</span> 0</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true"></a><span class="kw">fi</span></span></code></pre>
        </div>
      </section>
      <section>
        <h3 id="database-maintenance-and-monitoring">Database Maintenance and Monitoring</h3>
        <p>Regular maintenance is essential for keeping PostgreSQL databases performing optimally. As a product owner,
          understanding these maintenance tasks will help you plan for system downtime and resource allocation.</p>
        <p><strong>VACUUM and ANALYZE</strong>:</p>
        <p>PostgreSQL’s MVCC (Multi-Version Concurrency Control) system creates “dead” tuples when rows are updated or
          deleted. VACUUM reclaims this space and updates statistics.</p>
        <div class="sourceCode" id="cb19">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="co">-- Basic VACUUM</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>VACUUM table_name;</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a><span class="co">-- VACUUM with analysis</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>VACUUM <span class="kw">ANALYZE</span> table_name;</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a><span class="co">-- Full VACUUM (rewrites the entire table)</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a>VACUUM <span class="kw">FULL</span> table_name;</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true"></a><span class="co">-- ANALYZE only (updates statistics)</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true"></a><span class="kw">ANALYZE</span> table_name;</span></code></pre>
        </div>
        <p><strong>Automating Maintenance with Autovacuum</strong>:</p>
        <div class="sourceCode" id="cb20">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="co">-- Check autovacuum settings</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a>SHOW autovacuum;</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>SHOW autovacuum_vacuum_threshold;</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>SHOW autovacuum_analyze_threshold;</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a>SHOW autovacuum_vacuum_scale_factor;</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a>SHOW autovacuum_analyze_scale_factor;</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a><span class="co">-- Configure autovacuum for a specific table</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> large_table <span class="kw">SET</span> (</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a>    autovacuum_vacuum_threshold <span class="op">=</span> <span class="dv">1000</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a>    autovacuum_vacuum_scale_factor <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true"></a>    autovacuum_analyze_threshold <span class="op">=</span> <span class="dv">500</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true"></a>    autovacuum_analyze_scale_factor <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true"></a>);</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Monitoring Autovacuum</strong>:</p>
        <div class="sourceCode" id="cb21">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="co">-- Check autovacuum activity</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a><span class="kw">SELECT</span> datname, usename, <span class="kw">query</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a><span class="kw">FROM</span> pg_stat_activity</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a><span class="kw">WHERE</span> <span class="kw">query</span> <span class="kw">LIKE</span> <span class="st">&#39;autovacuum:%&#39;</span>;</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a><span class="co">-- Check when tables were last vacuumed and analyzed</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a>    schemaname,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true"></a>    relname,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true"></a>    n_live_tup,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true"></a>    n_dead_tup,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true"></a>    last_vacuum,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true"></a>    last_autovacuum,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true"></a>    last_analyze,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true"></a>    last_autoanalyze</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true"></a>    pg_stat_user_tables</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true"></a>    n_dead_tup <span class="kw">DESC</span>;</span></code></pre>
        </div>
        <p><strong>Index Maintenance</strong>:</p>
        <div class="sourceCode" id="cb22">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="co">-- Rebuild an index</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a>REINDEX <span class="kw">INDEX</span> index_name;</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a><span class="co">-- Rebuild all indexes on a table</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a>REINDEX <span class="kw">TABLE</span> table_name;</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true"></a><span class="co">-- Rebuild all indexes in a database</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true"></a>REINDEX <span class="kw">DATABASE</span> database_name;</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true"></a><span class="co">-- Check index usage</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true"></a>    schemaname,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true"></a>    relname,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true"></a>    indexrelname,</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true"></a>    idx_scan,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true"></a>    idx_tup_read,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true"></a>    idx_tup_fetch</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true"></a>    pg_stat_user_indexes</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true"></a><span class="kw">JOIN</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true"></a>    pg_stat_user_tables <span class="kw">ON</span> pg_stat_user_indexes.relid <span class="op">=</span> pg_stat_user_tables.relid</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true"></a>    idx_scan <span class="kw">DESC</span>;</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true"></a><span class="co">-- Find unused indexes</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true"></a>    schemaname,</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true"></a>    relname,</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true"></a>    indexrelname,</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true"></a>    idx_scan,</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true"></a>    pg_size_pretty(pg_relation_size(indexrelid)) <span class="kw">as</span> index_size</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true"></a>    pg_stat_user_indexes</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true"></a><span class="kw">WHERE</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true"></a>    idx_scan <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true"></a>    pg_relation_size(indexrelid) <span class="kw">DESC</span>;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Table Maintenance</strong>:</p>
        <div class="sourceCode" id="cb23">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="co">-- Reclaim space and optimize a table</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a>VACUUM <span class="kw">FULL</span> table_name;</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true"></a><span class="co">-- Rewrite a table to reclaim space and remove bloat</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true"></a><span class="kw">CLUSTER</span> table_name <span class="kw">USING</span> index_name;</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true"></a><span class="co">-- Reset all statistics</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true"></a><span class="kw">SELECT</span> pg_stat_reset();</span></code></pre>
        </div>
        <p><strong>Monitoring Database Size</strong>:</p>
        <div class="sourceCode" id="cb24">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="co">-- Database size</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a><span class="kw">SELECT</span> pg_size_pretty(pg_database_size(current_database()));</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a><span class="co">-- Table sizes</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a>    relname <span class="kw">AS</span> table_name,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a>    pg_size_pretty(pg_total_relation_size(relid)) <span class="kw">AS</span> total_size,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a>    pg_size_pretty(pg_relation_size(relid)) <span class="kw">AS</span> table_size,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true"></a>    pg_size_pretty(pg_total_relation_size(relid) <span class="op">-</span> pg_relation_size(relid)) <span class="kw">AS</span> index_size</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true"></a>    pg_catalog.pg_statio_user_tables</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true"></a>    pg_total_relation_size(relid) <span class="kw">DESC</span>;</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true"></a><span class="co">-- Largest tables including TOAST</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true"></a>    relname <span class="kw">AS</span> table_name,</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true"></a>    pg_size_pretty(pg_total_relation_size(c.<span class="kw">oid</span>)) <span class="kw">AS</span> total_size</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true"></a>    pg_class c</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true"></a>    pg_namespace n <span class="kw">ON</span> n.<span class="kw">oid</span> <span class="op">=</span> c.relnamespace</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true"></a><span class="kw">WHERE</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true"></a>    relkind <span class="op">=</span> <span class="st">&#39;r&#39;</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true"></a>    <span class="kw">AND</span> n.nspname <span class="kw">NOT</span> <span class="kw">IN</span> (<span class="st">&#39;pg_catalog&#39;</span>, <span class="st">&#39;information_schema&#39;</span>)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true"></a>    pg_total_relation_size(c.<span class="kw">oid</span>) <span class="kw">DESC</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true"></a><span class="kw">LIMIT</span> <span class="dv">20</span>;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Monitoring Connections</strong>:</p>
        <div class="sourceCode" id="cb25">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="co">-- Current connections</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a>    datname,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a>    usename,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a>    application_name,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a>    client_addr,</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true"></a>    state,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true"></a>    query_start,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true"></a>    wait_event_type,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true"></a>    wait_event,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true"></a>    <span class="kw">query</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true"></a>    pg_stat_activity</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true"></a><span class="kw">WHERE</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true"></a>    state <span class="op">!=</span> <span class="st">&#39;idle&#39;</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true"></a>    <span class="kw">AND</span> backend_type <span class="op">=</span> <span class="st">&#39;client backend&#39;</span>;</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true"></a><span class="co">-- Connection count by state</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true"></a>    state,</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true"></a>    pg_stat_activity</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true"></a>    state</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true"></a>    <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">DESC</span>;</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true"></a><span class="co">-- Long-running queries</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true"></a>    pid,</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true"></a>    usename,</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true"></a>    datname,</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true"></a>    query_start,</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true"></a>    NOW() <span class="op">-</span> query_start <span class="kw">AS</span> duration,</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true"></a>    state,</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true"></a>    <span class="kw">query</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true"></a>    pg_stat_activity</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true"></a><span class="kw">WHERE</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true"></a>    state <span class="op">!=</span> <span class="st">&#39;idle&#39;</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true"></a>    <span class="kw">AND</span> query_start <span class="op">&lt;</span> NOW() <span class="op">-</span> <span class="dt">INTERVAL</span> <span class="st">&#39;5 minutes&#39;</span></span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true"></a>    query_start;</span></code></pre>
        </div>
        <p><strong>Monitoring Locks</strong>:</p>
        <div class="sourceCode" id="cb26">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="co">-- View locks</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a>    l.relation:<span class="ch">:regclass</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a>    l.<span class="kw">mode</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true"></a>    l.granted,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true"></a>    a.<span class="kw">query</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true"></a>    a.pid</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true"></a>    pg_locks l</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true"></a><span class="kw">JOIN</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true"></a>    pg_stat_activity a <span class="kw">ON</span> l.pid <span class="op">=</span> a.pid</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true"></a><span class="kw">WHERE</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true"></a>    l.relation <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true"></a>    l.relation;</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true"></a><span class="co">-- Find blocking locks</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true"></a>    blocked.pid <span class="kw">AS</span> blocked_pid,</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true"></a>    blocked.usename <span class="kw">AS</span> blocked_user,</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true"></a>    blocking.pid <span class="kw">AS</span> blocking_pid,</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true"></a>    blocking.usename <span class="kw">AS</span> blocking_user,</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true"></a>    blocked.<span class="kw">query</span> <span class="kw">AS</span> blocked_query,</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true"></a>    blocking.<span class="kw">query</span> <span class="kw">AS</span> blocking_query</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true"></a>    pg_catalog.pg_locks blocked</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true"></a><span class="kw">JOIN</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true"></a>    pg_catalog.pg_locks blocking <span class="kw">ON</span> blocked.transactionid <span class="op">=</span> blocking.transactionid</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true"></a>    <span class="kw">AND</span> blocked.pid <span class="op">!=</span> blocking.pid</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true"></a><span class="kw">JOIN</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true"></a>    pg_catalog.pg_stat_activity blocked_activity <span class="kw">ON</span> blocked.pid <span class="op">=</span> blocked_activity.pid</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true"></a><span class="kw">JOIN</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true"></a>    pg_catalog.pg_stat_activity blocking_activity <span class="kw">ON</span> blocking.pid <span class="op">=</span> blocking_activity.pid</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true"></a><span class="kw">WHERE</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true"></a>    <span class="kw">NOT</span> blocked.granted;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Setting Up Monitoring Tools</strong>:</p>
        <ol type="1">
          <li><strong>pg_stat_statements</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb27">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a><span class="co">-- Enable the extension</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a><span class="kw">CREATE</span> EXTENSION pg_stat_statements;</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a><span class="co">-- View query statistics</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true"></a>    <span class="kw">query</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true"></a>    calls,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true"></a>    total_exec_time <span class="op">/</span> <span class="dv">1000</span> <span class="kw">AS</span> total_exec_time_sec,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true"></a>    mean_exec_time <span class="op">/</span> <span class="dv">1000</span> <span class="kw">AS</span> mean_exec_time_sec,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true"></a>    <span class="kw">rows</span>,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true"></a>    shared_blks_hit,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true"></a>    shared_blks_read</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true"></a>    pg_stat_statements</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true"></a><span class="kw">ORDER</span> <span class="kw">BY</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true"></a>    total_exec_time <span class="kw">DESC</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true"></a><span class="kw">LIMIT</span> <span class="dv">10</span>;</span></code></pre>
        </div>
        <ol start="2" type="1">
          <li><strong>pgBadger</strong> (Log Analyzer):</li>
        </ol>
        <div class="sourceCode" id="cb28">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a><span class="co"># Generate a report from PostgreSQL logs</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true"></a><span class="ex">pgbadger</span> /var/log/postgresql/postgresql.log -o report.html</span></code></pre>
        </div>
        <ol start="3" type="1">
          <li><strong>Prometheus and Grafana</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb29">
          <pre
            class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a><span class="co"># Example prometheus.yml configuration</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a><span class="fu">scrape_configs</span><span class="kw">:</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">job_name</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;postgres&#39;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true"></a><span class="at">    </span><span class="fu">static_configs</span><span class="kw">:</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">targets</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&#39;postgres_exporter:9187&#39;</span><span class="kw">]</span></span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Performance Tuning Parameters</strong>:</p>
        <div class="sourceCode" id="cb30">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a><span class="co">-- Memory settings</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a>SHOW shared_buffers;</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a>SHOW work_mem;</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a>SHOW maintenance_work_mem;</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a>SHOW effective_cache_size;</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true"></a><span class="co">-- Checkpoint settings</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true"></a>SHOW checkpoint_timeout;</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true"></a>SHOW checkpoint_completion_target;</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true"></a>SHOW max_wal_size;</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true"></a><span class="co">-- Planner settings</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true"></a>SHOW random_page_cost;</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true"></a>SHOW effective_io_concurrency;</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true"></a>SHOW default_statistics_target;</span></code></pre>
        </div>
        <p><strong>Common Configuration Adjustments</strong>:</p>
        <pre><code># Memory settings
shared_buffers = 2GB                  # 25% of RAM for dedicated servers
work_mem = 32MB                       # Depends on complex query needs
maintenance_work_mem = 256MB          # For VACUUM, CREATE INDEX, etc.
effective_cache_size = 6GB            # 75% of RAM for dedicated servers

# Checkpoint settings
checkpoint_timeout = 15min            # Time between checkpoints
checkpoint_completion_target = 0.9    # Spread checkpoint I/O over time
max_wal_size = 1GB                    # Maximum WAL between checkpoints

# Planner settings
random_page_cost = 1.1                # Lower for SSDs
effective_io_concurrency = 200        # Higher for SSDs
default_statistics_target = 100       # Increase for complex queries</code></pre>
      </section>
      <section>
        <h3 id="security-best-practices">Security Best Practices</h3>
        <p>Database security is a critical concern for any organization. As a product owner, understanding security best
          practices will help you protect sensitive data and comply with regulations.</p>
        <p><strong>Authentication Methods</strong>:</p>
        <p>PostgreSQL supports several authentication methods, configured in <code>pg_hba.conf</code>:</p>
        <pre><code># TYPE  DATABASE        USER            ADDRESS                 METHOD
local   all             postgres                                peer
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
host    production      app_user        192.168.1.0/24          scram-sha-256
host    replication     repl_user       192.168.1.5/32          scram-sha-256</code></pre>
        <p><strong>Authentication Methods</strong>: - <code>trust</code>: No password required (insecure) -
          <code>password</code>: Clear-text password (insecure) - <code>md5</code>: MD5-hashed password -
          <code>scram-sha-256</code>: SCRAM-SHA-256 authentication (most secure) - <code>peer</code>: Use operating
          system
          username - <code>ident</code>: Use operating system username via ident server - <code>cert</code>: SSL client
          certificate
        </p>
      </section>
      <section>
        <p><strong>User and Role Management</strong>:</p>
        <div class="sourceCode" id="cb33">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true"></a><span class="co">-- Create a role with login capability</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">ROLE</span> app_user <span class="kw">WITH</span> LOGIN <span class="kw">PASSWORD</span> <span class="st">&#39;secure_password&#39;</span>;</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true"></a><span class="co">-- Create a group role</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">ROLE</span> analysts;</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true"></a><span class="co">-- Grant membership</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true"></a><span class="kw">GRANT</span> analysts <span class="kw">TO</span> alice, bob;</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true"></a><span class="co">-- Create a role with specific attributes</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">ROLE</span> admin_user <span class="kw">WITH</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true"></a>    LOGIN</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true"></a>    <span class="kw">PASSWORD</span> <span class="st">&#39;very_secure_password&#39;</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true"></a>    CREATEDB</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true"></a>    CREATEROLE</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true"></a>    REPLICATION</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true"></a>    CONNECTION <span class="kw">LIMIT</span> <span class="dv">10</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true"></a>    VALID <span class="kw">UNTIL</span> <span class="st">&#39;2024-12-31&#39;</span>;</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true"></a></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true"></a><span class="co">-- Alter role attributes</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">ROLE</span> app_user <span class="kw">WITH</span> CONNECTION <span class="kw">LIMIT</span> <span class="dv">20</span>;</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true"></a></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true"></a><span class="co">-- Change password</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">ROLE</span> app_user <span class="kw">WITH</span> <span class="kw">PASSWORD</span> <span class="st">&#39;new_secure_password&#39;</span>;</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true"></a><span class="co">-- Force password change on next login (PostgreSQL 10+)</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">ROLE</span> app_user <span class="kw">WITH</span> <span class="kw">PASSWORD</span> <span class="st">&#39;temporary_password&#39;</span> VALID <span class="kw">UNTIL</span> <span class="st">&#39;infinity&#39;</span>;</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">ROLE</span> app_user <span class="kw">SET</span> password_encryption <span class="op">=</span> <span class="st">&#39;scram-sha-256&#39;</span>;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Privilege Management</strong>:</p>
        <div class="sourceCode" id="cb34">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a><span class="co">-- Grant table privileges</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true"></a><span class="kw">GRANT</span> <span class="kw">SELECT</span>, <span class="kw">INSERT</span>, <span class="kw">UPDATE</span> <span class="kw">ON</span> table_name <span class="kw">TO</span> role_name;</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true"></a><span class="co">-- Grant all privileges on a table</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true"></a><span class="kw">GRANT</span> <span class="kw">ALL</span> <span class="kw">PRIVILEGES</span> <span class="kw">ON</span> table_name <span class="kw">TO</span> role_name;</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true"></a><span class="co">-- Grant column-level privileges</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true"></a><span class="kw">GRANT</span> <span class="kw">SELECT</span> (column1, column2), <span class="kw">UPDATE</span> (column1) <span class="kw">ON</span> table_name <span class="kw">TO</span> role_name;</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true"></a><span class="co">-- Grant schema privileges</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true"></a><span class="kw">GRANT</span> <span class="kw">USAGE</span> <span class="kw">ON</span> <span class="kw">SCHEMA</span> schema_name <span class="kw">TO</span> role_name;</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true"></a><span class="kw">GRANT</span> <span class="kw">ALL</span> <span class="kw">PRIVILEGES</span> <span class="kw">ON</span> <span class="kw">ALL</span> <span class="kw">TABLES</span> <span class="kw">IN</span> <span class="kw">SCHEMA</span> schema_name <span class="kw">TO</span> role_name;</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true"></a><span class="co">-- Grant function execution privileges</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true"></a><span class="kw">GRANT</span> <span class="kw">EXECUTE</span> <span class="kw">ON</span> <span class="kw">FUNCTION</span> function_name(arg_type) <span class="kw">TO</span> role_name;</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true"></a><span class="co">-- Revoke privileges</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true"></a><span class="kw">REVOKE</span> <span class="kw">UPDATE</span> <span class="kw">ON</span> table_name <span class="kw">FROM</span> role_name;</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true"></a></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true"></a><span class="co">-- View granted privileges</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> information_schema.role_table_grants <span class="kw">WHERE</span> grantee <span class="op">=</span> <span class="st">&#39;role_name&#39;</span>;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Row-Level Security (RLS)</strong>:</p>
        <div class="sourceCode" id="cb35">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true"></a><span class="co">-- Enable RLS on a table</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> customer <span class="kw">ENABLE</span> <span class="kw">ROW</span> <span class="kw">LEVEL</span> SECURITY;</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true"></a><span class="co">-- Create a policy</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true"></a><span class="kw">CREATE</span> POLICY customer_access <span class="kw">ON</span> customer</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true"></a>    <span class="cf">FOR</span> <span class="kw">SELECT</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true"></a>    <span class="kw">USING</span> (created_by <span class="op">=</span> current_user);</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true"></a><span class="co">-- Policy for different operations</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true"></a><span class="kw">CREATE</span> POLICY customer_update <span class="kw">ON</span> customer</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true"></a>    <span class="cf">FOR</span> <span class="kw">UPDATE</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true"></a>    <span class="kw">USING</span> (created_by <span class="op">=</span> current_user);</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true"></a><span class="co">-- Policy with multiple conditions</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true"></a><span class="kw">CREATE</span> POLICY regional_access <span class="kw">ON</span> customer</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true"></a>    <span class="cf">FOR</span> <span class="kw">ALL</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true"></a>    <span class="kw">USING</span> (region_id <span class="kw">IN</span> (<span class="kw">SELECT</span> region_id <span class="kw">FROM</span> user_regions <span class="kw">WHERE</span> user_name <span class="op">=</span> current_user));</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true"></a><span class="co">-- Force RLS for table owners</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> customer <span class="kw">FORCE</span> <span class="kw">ROW</span> <span class="kw">LEVEL</span> SECURITY;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Data Encryption</strong>:</p>
        <ol type="1">
          <li><strong>Column-Level Encryption</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb36">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true"></a><span class="co">-- Install pgcrypto</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true"></a><span class="kw">CREATE</span> EXTENSION pgcrypto;</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true"></a><span class="co">-- Encrypt data</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> sensitive_data (</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true"></a>    <span class="kw">id</span> serial <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true"></a>    name text,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true"></a>    ssn text,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true"></a>    encrypted_ssn bytea</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true"></a>);</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true"></a><span class="co">-- Insert with encryption</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> sensitive_data (name, ssn, encrypted_ssn)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true"></a><span class="kw">VALUES</span> (</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true"></a>    <span class="st">&#39;John Doe&#39;</span>,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true"></a>    <span class="st">&#39;123-45-6789&#39;</span>,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true"></a>    pgp_sym_encrypt(<span class="st">&#39;123-45-6789&#39;</span>, <span class="st">&#39;encryption_key&#39;</span>)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true"></a>);</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true"></a><span class="co">-- Query encrypted data</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true"></a>    name,</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true"></a>    pgp_sym_decrypt(encrypted_ssn, <span class="st">&#39;encryption_key&#39;</span>) <span class="kw">AS</span> decrypted_ssn</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true"></a>    sensitive_data;</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="2" type="1">
          <li><strong>SSL Configuration</strong>:</li>
        </ol>
        <p>In <code>postgresql.conf</code>:</p>
        <pre><code>ssl = on
ssl_cert_file = &#39;server.crt&#39;
ssl_key_file = &#39;server.key&#39;
ssl_ca_file = &#39;root.crt&#39;</code></pre>
        <p>In <code>pg_hba.conf</code>:</p>
        <pre><code>hostssl all all 0.0.0.0/0 scram-sha-256</code></pre>
      </section>
      <section>
        <p><strong>Audit Logging</strong>:</p>
        <ol type="1">
          <li><strong>Using PostgreSQL Logging</strong>:</li>
        </ol>
        <p>In <code>postgresql.conf</code>:</p>
        <pre><code>log_statement = &#39;mod&#39;           # Log all modification statements
log_min_duration_statement = 0  # Log all statements and their durations</code></pre>
        <ol start="2" type="1">
          <li><strong>Using Triggers for Audit Trails</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb40">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true"></a><span class="co">-- Create audit table</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> audit_log (</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true"></a>    audit_id serial <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true"></a>    table_name text <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true"></a>    operation text <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true"></a>    record_id <span class="dt">integer</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true"></a>    changed_by text <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true"></a>    changed_at <span class="dt">timestamp</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true"></a>    old_data jsonb,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true"></a>    new_data jsonb</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true"></a>);</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true"></a><span class="co">-- Create audit function</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> audit_trigger_function()</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true"></a>RETURNS <span class="kw">trigger</span> <span class="kw">AS</span> $$</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true"></a>    <span class="cf">IF</span> (TG_OP <span class="op">=</span> <span class="st">&#39;DELETE&#39;</span>) <span class="cf">THEN</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true"></a>        <span class="kw">INSERT</span> <span class="kw">INTO</span> audit_log (</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true"></a>            table_name,</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true"></a>            operation,</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true"></a>            record_id,</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true"></a>            changed_by,</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true"></a>            old_data</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true"></a>        )</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true"></a>        <span class="kw">VALUES</span> (</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true"></a>            TG_TABLE_NAME,</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true"></a>            TG_OP,</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true"></a>            <span class="kw">OLD</span>.<span class="kw">id</span>,</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true"></a>            current_user,</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true"></a>            to_jsonb(<span class="kw">OLD</span>)</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true"></a>        );</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true"></a>        <span class="kw">RETURN</span> <span class="kw">OLD</span>;</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true"></a>    <span class="cf">ELSIF</span> (TG_OP <span class="op">=</span> <span class="st">&#39;UPDATE&#39;</span>) <span class="cf">THEN</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true"></a>        <span class="kw">INSERT</span> <span class="kw">INTO</span> audit_log (</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true"></a>            table_name,</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true"></a>            operation,</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true"></a>            record_id,</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true"></a>            changed_by,</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true"></a>            old_data,</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true"></a>            new_data</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true"></a>        )</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true"></a>        <span class="kw">VALUES</span> (</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true"></a>            TG_TABLE_NAME,</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true"></a>            TG_OP,</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true"></a>            <span class="kw">NEW</span>.<span class="kw">id</span>,</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true"></a>            current_user,</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true"></a>            to_jsonb(<span class="kw">OLD</span>),</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true"></a>            to_jsonb(<span class="kw">NEW</span>)</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true"></a>        );</span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true"></a>        <span class="kw">RETURN</span> <span class="kw">NEW</span>;</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true"></a>    <span class="cf">ELSIF</span> (TG_OP <span class="op">=</span> <span class="st">&#39;INSERT&#39;</span>) <span class="cf">THEN</span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true"></a>        <span class="kw">INSERT</span> <span class="kw">INTO</span> audit_log (</span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true"></a>            table_name,</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true"></a>            operation,</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true"></a>            record_id,</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true"></a>            changed_by,</span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true"></a>            new_data</span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true"></a>        )</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true"></a>        <span class="kw">VALUES</span> (</span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true"></a>            TG_TABLE_NAME,</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true"></a>            TG_OP,</span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true"></a>            <span class="kw">NEW</span>.<span class="kw">id</span>,</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true"></a>            current_user,</span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true"></a>            to_jsonb(<span class="kw">NEW</span>)</span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true"></a>        );</span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true"></a>        <span class="kw">RETURN</span> <span class="kw">NEW</span>;</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true"></a>    <span class="kw">RETURN</span> <span class="kw">NULL</span>;</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true"></a></span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true"></a><span class="co">-- Apply to tables</span></span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TRIGGER</span> audit_customer</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true"></a><span class="kw">AFTER</span> <span class="kw">INSERT</span> <span class="kw">OR</span> <span class="kw">UPDATE</span> <span class="kw">OR</span> <span class="kw">DELETE</span> <span class="kw">ON</span> customer</span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true"></a><span class="cf">FOR</span> <span class="kw">EACH</span> <span class="kw">ROW</span> <span class="kw">EXECUTE</span> <span class="kw">FUNCTION</span> audit_trigger_function();</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Security Best Practices Checklist</strong>:</p>
        <ol type="1">
          <li><strong>Authentication</strong>:
            <ul>
              <li>Use strong authentication methods (scram-sha-256)</li>
              <li>Implement password policies</li>
              <li>Limit connection attempts</li>
            </ul>
          </li>
          <li><strong>Authorization</strong>:
            <ul>
              <li>Follow principle of least privilege</li>
              <li>Use roles for group permissions</li>
              <li>Implement row-level security for multi-tenant data</li>
            </ul>
          </li>
          <li><strong>Network Security</strong>:
            <ul>
              <li>Use SSL/TLS for connections</li>
              <li>Restrict IP access in pg_hba.conf</li>
              <li>Use VPN or SSH tunnels for remote access</li>
            </ul>
          </li>
          <li><strong>Data Protection</strong>:
            <ul>
              <li>Encrypt sensitive columns</li>
              <li>Implement data masking for non-production environments</li>
              <li>Regular security audits</li>
            </ul>
          </li>
          <li><strong>Monitoring and Auditing</strong>:
            <ul>
              <li>Enable appropriate logging</li>
              <li>Implement audit trails</li>
              <li>Monitor for suspicious activity</li>
            </ul>
          </li>
        </ol>
      </section>
      <section>
        <h3 id="high-availability-and-replication">High Availability and Replication</h3>
        <p>High availability ensures that your database remains accessible even in the face of hardware failures or
          maintenance operations. As a product owner, understanding these concepts will help you plan for system
          resilience and disaster recovery.</p>
        <p><strong>Replication Methods in PostgreSQL</strong>:</p>
        <ol type="1">
          <li><strong>Physical Replication</strong>:
            <ul>
              <li>Replicates the entire database cluster</li>
              <li>Uses Write-Ahead Log (WAL) shipping</li>
              <li>Standby servers can be used for read-only queries</li>
              <li>Provides high availability and disaster recovery</li>
            </ul>
          </li>
          <li><strong>Logical Replication</strong>:
            <ul>
              <li>Replicates specific tables</li>
              <li>Uses a publish/subscribe model</li>
              <li>Allows replication between different PostgreSQL versions</li>
              <li>Useful for upgrading, migrating, or integrating systems</li>
            </ul>
          </li>
        </ol>
      </section>
      <section>
        <p><strong>Setting Up Physical Replication</strong>:</p>
        <ol type="1">
          <li><strong>Primary Server Configuration</strong> (<code>postgresql.conf</code>):</li>
        </ol>
        <pre><code># Replication settings
wal_level = replica
max_wal_senders = 10
max_replication_slots = 10</code></pre>
        <ol start="2" type="1">
          <li><strong>Primary Server Authentication</strong> (<code>pg_hba.conf</code>):</li>
        </ol>
        <pre><code># Allow replication connections
host    replication     repl_user      192.168.1.0/24        scram-sha-256</code></pre>
        <ol start="3" type="1">
          <li><strong>Create Replication User</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb43">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">ROLE</span> repl_user <span class="kw">WITH</span> REPLICATION LOGIN <span class="kw">PASSWORD</span> <span class="st">&#39;secure_password&#39;</span>;</span></code></pre>
        </div>
        <ol start="4" type="1">
          <li><strong>Create Base Backup</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb44">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true"></a><span class="ex">pg_basebackup</span> -h primary_host -D /var/lib/postgresql/data -U repl_user -P -v</span></code></pre>
        </div>
        <ol start="5" type="1">
          <li><strong>Standby Server Configuration</strong> (<code>postgresql.conf</code>):</li>
        </ol>
        <pre><code># Standby settings
primary_conninfo = &#39;host=primary_host port=5432 user=repl_user password=secure_password&#39;</code></pre>
        <ol start="6" type="1">
          <li><strong>Create Standby Signal File</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb46">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true"></a><span class="fu">touch</span> /var/lib/postgresql/data/standby.signal</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Setting Up Logical Replication</strong>:</p>
        <ol type="1">
          <li><strong>Publisher Configuration</strong> (<code>postgresql.conf</code>):</li>
        </ol>
        <pre><code># Logical replication settings
wal_level = logical
max_replication_slots = 10
max_wal_senders = 10</code></pre>
        <ol start="2" type="1">
          <li><strong>Create Publication</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb48">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true"></a><span class="co">-- Create publication for specific tables</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true"></a><span class="kw">CREATE</span> PUBLICATION sales_pub <span class="cf">FOR</span> <span class="kw">TABLE</span> orders, customers;</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true"></a><span class="co">-- Create publication for all tables</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true"></a><span class="kw">CREATE</span> PUBLICATION all_tables <span class="cf">FOR</span> <span class="kw">ALL</span> <span class="kw">TABLES</span>;</span></code></pre>
        </div>
        <ol start="3" type="1">
          <li><strong>Subscriber Configuration</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb49">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true"></a><span class="co">-- Create subscription</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true"></a><span class="kw">CREATE</span> SUBSCRIPTION sales_sub</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true"></a>CONNECTION <span class="st">&#39;host=publisher_host port=5432 dbname=source_db user=repl_user password=secure_password&#39;</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true"></a>PUBLICATION sales_pub;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Monitoring Replication</strong>:</p>
        <div class="sourceCode" id="cb50">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true"></a><span class="co">-- Check replication status on primary</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true"></a>    client_addr,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true"></a>    state,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true"></a>    sent_lsn,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true"></a>    write_lsn,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true"></a>    flush_lsn,</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true"></a>    replay_lsn,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true"></a>    sync_state</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true"></a>    pg_stat_replication;</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true"></a><span class="co">-- Check replication lag on primary</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true"></a>    client_addr,</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true"></a>    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) <span class="kw">AS</span> lag_bytes</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true"></a>    pg_stat_replication;</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true"></a></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true"></a><span class="co">-- Check replication status on standby</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true"></a>    pg_last_wal_receive_lsn(),</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true"></a>    pg_last_wal_replay_lsn(),</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true"></a>    pg_last_xact_replay_timestamp();</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true"></a></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true"></a><span class="co">-- Check replication lag on standby</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true"></a>    <span class="fu">EXTRACT</span>(EPOCH <span class="kw">FROM</span> (now() <span class="op">-</span> pg_last_xact_replay_timestamp())) <span class="kw">AS</span> lag_seconds;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Failover and Switchover</strong>:</p>
        <ol type="1">
          <li><strong>Manual Failover</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb51">
          <pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true"></a><span class="co"># On standby server</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true"></a><span class="ex">pg_ctl</span> promote</span></code></pre>
        </div>
        <ol start="2" type="1">
          <li><strong>Using pg_rewind After Failover</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb52">
          <pre
            class="sourceCode bash"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true"></a><span class="co"># On old primary (now standby)</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true"></a><span class="ex">pg_rewind</span> --target-pgdata=/var/lib/postgresql/data --source-server=<span class="st">&quot;host=new_primary port=5432 user=postgres dbname=postgres&quot;</span></span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>High Availability Solutions</strong>:</p>
        <ol type="1">
          <li><strong>Patroni</strong>:
            <ul>
              <li>Open-source HA solution</li>
              <li>Uses etcd, Consul, or ZooKeeper for consensus</li>
              <li>Automated failover</li>
              <li>REST API for management</li>
            </ul>
          </li>
          <li><strong>repmgr</strong>:
            <ul>
              <li>Open-source replication manager</li>
              <li>Monitors replication</li>
              <li>Provides failover capabilities</li>
              <li>Command-line tools for management</li>
            </ul>
          </li>
          <li><strong>pgpool-II</strong>:
            <ul>
              <li>Connection pooling</li>
              <li>Load balancing</li>
              <li>Automated failover</li>
              <li>Query caching</li>
            </ul>
          </li>
        </ol>
      </section>
      <section>
        <p><strong>Connection Pooling</strong>:</p>
        <ol type="1">
          <li><strong>pgBouncer</strong>:
            <ul>
              <li>Lightweight connection pooler</li>
              <li>Session, transaction, or statement pooling modes</li>
              <li>Low overhead</li>
            </ul>
          </li>
          <li><strong>pgpool-II</strong>:
            <ul>
              <li>Connection pooling with additional features</li>
              <li>Load balancing</li>
              <li>Parallel query</li>
              <li>Higher overhead than pgBouncer</li>
            </ul>
          </li>
        </ol>
        <p><strong>Example pgBouncer Configuration</strong>:</p>
        <div class="sourceCode" id="cb53">
          <pre
            class="sourceCode ini"><code class="sourceCode ini"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true"></a><span class="kw">[databases]</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true"></a><span class="dt">mydb </span><span class="ot">=</span><span class="st"> host=</span><span class="kw">localhost</span><span class="st"> port=</span><span class="dv">5432</span><span class="st"> dbname=mydb</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true"></a><span class="kw">[pgbouncer]</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true"></a><span class="dt">listen_addr </span><span class="ot">=</span><span class="st"> *</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true"></a><span class="dt">listen_port </span><span class="ot">=</span><span class="st"> </span><span class="dv">6432</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true"></a><span class="dt">auth_type </span><span class="ot">=</span><span class="st"> md5</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true"></a><span class="dt">auth_file </span><span class="ot">=</span><span class="st"> /etc/pgbouncer/userlist.txt</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true"></a><span class="dt">pool_mode </span><span class="ot">=</span><span class="st"> transaction</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true"></a><span class="dt">max_client_conn </span><span class="ot">=</span><span class="st"> </span><span class="dv">1000</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true"></a><span class="dt">default_pool_size </span><span class="ot">=</span><span class="st"> </span><span class="dv">20</span></span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>High Availability Architecture Example</strong>:</p>
        <pre><code>                   ┌─────────────────┐
                   │   Load Balancer │
                   └────────┬────────┘
                            │
           ┌────────────────┴────────────────┐
           │                                 │
┌──────────▼─────────┐            ┌──────────▼─────────┐
│  pgBouncer (Read)  │            │ pgBouncer (Write)  │
└──────────┬─────────┘            └──────────┬─────────┘
           │                                 │
           │                                 │
┌──────────▼─────────┐            ┌──────────▼─────────┐
│  PostgreSQL Primary │◄───WAL────┤ PostgreSQL Standby │
└────────────────────┘            └────────────────────┘
           ▲                                 ▲
           │                                 │
           └─────────Patroni/etcd───────────┘</code></pre>
      </section>
      <section>
        <h3 id="scaling-postgresql">Scaling PostgreSQL</h3>
        <p>As your application grows, you may need to scale your PostgreSQL database to handle increased load. As a
          product owner, understanding scaling options will help you plan for growth and performance needs.</p>
        <p><strong>Vertical Scaling (Scaling Up)</strong>:</p>
        <ol type="1">
          <li>
            <p><strong>Hardware Upgrades</strong>:</p>
            <ul>
              <li>More CPU cores</li>
              <li>More RAM</li>
              <li>Faster storage (SSDs, NVMe)</li>
              <li>Faster network</li>
            </ul>
          </li>
          <li>
            <p><strong>Configuration Tuning</strong>:</p>
            <pre><code>shared_buffers = 8GB          # 25% of RAM
work_mem = 64MB               # Increase for complex queries
maintenance_work_mem = 1GB    # Increase for maintenance operations
effective_cache_size = 24GB   # 75% of RAM</code></pre>
          </li>
        </ol>
      </section>
      <section>
        <p><strong>Horizontal Scaling (Scaling Out)</strong>:</p>
        <ol type="1">
          <li><strong>Read Replicas</strong>:
            <ul>
              <li>Offload read queries to standby servers</li>
              <li>Distribute read load across multiple servers</li>
              <li>Implemented with physical or logical replication</li>
            </ul>
          </li>
          <li><strong>Sharding</strong>:
            <ul>
              <li>Partition data across multiple PostgreSQL instances</li>
              <li>Each shard contains a subset of the data</li>
              <li>Application must route queries to the appropriate shard</li>
            </ul>
          </li>
          <li><strong>Connection Pooling</strong>:
            <ul>
              <li>Reduce connection overhead</li>
              <li>Efficiently use database connections</li>
              <li>Implemented with pgBouncer or pgpool-II</li>
            </ul>
          </li>
        </ol>
      </section>
      <section>
        <p><strong>Implementing Read/Write Splitting</strong>:</p>
        <div class="sourceCode" id="cb56">
          <pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true"></a><span class="co"># Python example with psycopg2</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true"></a><span class="im">import</span> psycopg2</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true"></a><span class="im">import</span> random</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true"></a><span class="co"># Connection pool</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true"></a>read_replicas <span class="op">=</span> [</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true"></a>    {<span class="st">&quot;host&quot;</span>: <span class="st">&quot;replica1.example.com&quot;</span>, <span class="st">&quot;port&quot;</span>: <span class="dv">5432</span>},</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true"></a>    {<span class="st">&quot;host&quot;</span>: <span class="st">&quot;replica2.example.com&quot;</span>, <span class="st">&quot;port&quot;</span>: <span class="dv">5432</span>},</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true"></a>    {<span class="st">&quot;host&quot;</span>: <span class="st">&quot;replica3.example.com&quot;</span>, <span class="st">&quot;port&quot;</span>: <span class="dv">5432</span>}</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true"></a>]</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true"></a></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true"></a>primary <span class="op">=</span> {<span class="st">&quot;host&quot;</span>: <span class="st">&quot;primary.example.com&quot;</span>, <span class="st">&quot;port&quot;</span>: <span class="dv">5432</span>}</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true"></a></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true"></a><span class="kw">def</span> get_read_connection():</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true"></a>    <span class="co"># Randomly select a read replica</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true"></a>    replica <span class="op">=</span> random.choice(read_replicas)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true"></a>    <span class="cf">return</span> psycopg2.<span class="ex">connect</span>(</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true"></a>        host<span class="op">=</span>replica[<span class="st">&quot;host&quot;</span>],</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true"></a>        port<span class="op">=</span>replica[<span class="st">&quot;port&quot;</span>],</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true"></a>        dbname<span class="op">=</span><span class="st">&quot;mydb&quot;</span>,</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true"></a>        user<span class="op">=</span><span class="st">&quot;app_user&quot;</span>,</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true"></a>        password<span class="op">=</span><span class="st">&quot;password&quot;</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true"></a>    )</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true"></a></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true"></a><span class="kw">def</span> get_write_connection():</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true"></a>    <span class="cf">return</span> psycopg2.<span class="ex">connect</span>(</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true"></a>        host<span class="op">=</span>primary[<span class="st">&quot;host&quot;</span>],</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true"></a>        port<span class="op">=</span>primary[<span class="st">&quot;port&quot;</span>],</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true"></a>        dbname<span class="op">=</span><span class="st">&quot;mydb&quot;</span>,</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true"></a>        user<span class="op">=</span><span class="st">&quot;app_user&quot;</span>,</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true"></a>        password<span class="op">=</span><span class="st">&quot;password&quot;</span></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true"></a>    )</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true"></a></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true"></a><span class="co"># Example usage</span></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true"></a><span class="kw">def</span> get_user(user_id):</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true"></a>    conn <span class="op">=</span> get_read_connection()</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true"></a>    <span class="cf">try</span>:</span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true"></a>        cur.execute(<span class="st">&quot;SELECT * FROM users WHERE id = </span><span class="sc">%s</span><span class="st">&quot;</span>, (user_id,))</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true"></a>        <span class="cf">return</span> cur.fetchone()</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true"></a>    <span class="cf">finally</span>:</span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true"></a>        conn.close()</span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true"></a></span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true"></a><span class="kw">def</span> update_user(user_id, name):</span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true"></a>    conn <span class="op">=</span> get_write_connection()</span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true"></a>    <span class="cf">try</span>:</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true"></a>        cur.execute(<span class="st">&quot;UPDATE users SET name = </span><span class="sc">%s</span><span class="st"> WHERE id = </span><span class="sc">%s</span><span class="st">&quot;</span>, (name, user_id))</span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true"></a>        conn.commit()</span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true"></a>    <span class="cf">finally</span>:</span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true"></a>        conn.close()</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Implementing Sharding</strong>:</p>
        <ol type="1">
          <li><strong>Hash-Based Sharding</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb57">
          <pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true"></a><span class="co"># Python example of hash-based sharding</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true"></a><span class="kw">def</span> get_shard_connection(user_id):</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true"></a>    <span class="co"># Determine shard based on user_id</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true"></a>    shard_id <span class="op">=</span> <span class="bu">hash</span>(user_id) <span class="op">%</span> NUM_SHARDS</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true"></a>    </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true"></a>    <span class="co"># Get connection to the appropriate shard</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true"></a>    shard_config <span class="op">=</span> SHARD_CONFIGS[shard_id]</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true"></a>    <span class="cf">return</span> psycopg2.<span class="ex">connect</span>(</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true"></a>        host<span class="op">=</span>shard_config[<span class="st">&quot;host&quot;</span>],</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true"></a>        port<span class="op">=</span>shard_config[<span class="st">&quot;port&quot;</span>],</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true"></a>        dbname<span class="op">=</span>shard_config[<span class="st">&quot;dbname&quot;</span>],</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true"></a>        user<span class="op">=</span><span class="st">&quot;app_user&quot;</span>,</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true"></a>        password<span class="op">=</span><span class="st">&quot;password&quot;</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true"></a>    )</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true"></a></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true"></a><span class="kw">def</span> get_user(user_id):</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true"></a>    conn <span class="op">=</span> get_shard_connection(user_id)</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true"></a>    <span class="cf">try</span>:</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true"></a>        cur.execute(<span class="st">&quot;SELECT * FROM users WHERE id = </span><span class="sc">%s</span><span class="st">&quot;</span>, (user_id,))</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true"></a>        <span class="cf">return</span> cur.fetchone()</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true"></a>    <span class="cf">finally</span>:</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true"></a>        conn.close()</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="2" type="1">
          <li><strong>Range-Based Sharding</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb58">
          <pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true"></a><span class="co">-- Create sharded tables</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> orders_2023_q1 (</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true"></a>    <span class="kw">LIKE</span> orders <span class="kw">INCLUDING</span> <span class="kw">ALL</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true"></a>);</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> orders_2023_q2 (</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true"></a>    <span class="kw">LIKE</span> orders <span class="kw">INCLUDING</span> <span class="kw">ALL</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true"></a>);</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true"></a><span class="co">-- Create view to unify access</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> all_orders <span class="kw">AS</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true"></a>    <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> orders_2023_q1</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true"></a>    <span class="kw">UNION</span> <span class="kw">ALL</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true"></a>    <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> orders_2023_q2;</span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true"></a></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true"></a><span class="co">-- Create routing function</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">FUNCTION</span> insert_order(</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true"></a>    p_customer_id <span class="dt">integer</span>,</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true"></a>    p_order_date <span class="dt">date</span>,</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true"></a>    p_amount <span class="dt">numeric</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true"></a>) RETURNS void <span class="kw">AS</span> $$</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true"></a><span class="cf">BEGIN</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true"></a>    <span class="cf">IF</span> p_order_date <span class="op">&gt;=</span> <span class="st">&#39;2023-01-01&#39;</span> <span class="kw">AND</span> p_order_date <span class="op">&lt;</span> <span class="st">&#39;2023-04-01&#39;</span> <span class="cf">THEN</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true"></a>        <span class="kw">INSERT</span> <span class="kw">INTO</span> orders_2023_q1 (customer_id, order_date, amount)</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true"></a>        <span class="kw">VALUES</span> (p_customer_id, p_order_date, p_amount);</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true"></a>    <span class="cf">ELSIF</span> p_order_date <span class="op">&gt;=</span> <span class="st">&#39;2023-04-01&#39;</span> <span class="kw">AND</span> p_order_date <span class="op">&lt;</span> <span class="st">&#39;2023-07-01&#39;</span> <span class="cf">THEN</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true"></a>        <span class="kw">INSERT</span> <span class="kw">INTO</span> orders_2023_q2 (customer_id, order_date, amount)</span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true"></a>        <span class="kw">VALUES</span> (p_customer_id, p_order_date, p_amount);</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true"></a>    <span class="cf">ELSE</span></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true"></a>        RAISE <span class="kw">EXCEPTION</span> <span class="st">&#39;No shard available for date %&#39;</span>, p_order_date;</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true"></a>    <span class="cf">END</span> <span class="cf">IF</span>;</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true"></a><span class="cf">END</span>;</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true"></a>$$ LANGUAGE plpgsql;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Table Partitioning</strong>:</p>
        <div class="sourceCode" id="cb59">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true"></a><span class="co">-- Create a partitioned table</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> orders (</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true"></a>    <span class="kw">id</span> serial,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true"></a>    order_date <span class="dt">date</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true"></a>    customer_id <span class="dt">integer</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true"></a>    amount <span class="dt">numeric</span>(<span class="dv">10</span>,<span class="dv">2</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true"></a>    <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="kw">id</span>, order_date)</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true"></a>) <span class="kw">PARTITION</span> <span class="kw">BY</span> <span class="kw">RANGE</span> (order_date);</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true"></a></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true"></a><span class="co">-- Create partitions</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> orders_2023_q1 <span class="kw">PARTITION</span> <span class="kw">OF</span> orders</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">&#39;2023-01-01&#39;</span>) <span class="kw">TO</span> (<span class="st">&#39;2023-04-01&#39;</span>);</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true"></a></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> orders_2023_q2 <span class="kw">PARTITION</span> <span class="kw">OF</span> orders</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true"></a>    <span class="cf">FOR</span> <span class="kw">VALUES</span> <span class="kw">FROM</span> (<span class="st">&#39;2023-04-01&#39;</span>) <span class="kw">TO</span> (<span class="st">&#39;2023-07-01&#39;</span>);</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true"></a></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true"></a><span class="co">-- Insert data (automatically routed to the correct partition)</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> orders (order_date, customer_id, amount)</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true"></a><span class="kw">VALUES</span> (<span class="st">&#39;2023-02-15&#39;</span>, <span class="dv">123</span>, <span class="fl">500.00</span>);</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true"></a></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true"></a><span class="co">-- Query specific partitions</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true"></a><span class="kw">EXPLAIN</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> orders</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true"></a><span class="kw">WHERE</span> order_date <span class="kw">BETWEEN</span> <span class="st">&#39;2023-01-01&#39;</span> <span class="kw">AND</span> <span class="st">&#39;2023-03-31&#39;</span>;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Caching Strategies</strong>:</p>
        <ol type="1">
          <li><strong>Application-Level Caching</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb60">
          <pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true"></a><span class="co"># Python example with Redis</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true"></a><span class="im">import</span> redis</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true"></a><span class="im">import</span> json</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true"></a><span class="im">import</span> psycopg2</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true"></a><span class="co"># Initialize Redis client</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true"></a>redis_client <span class="op">=</span> redis.Redis(host<span class="op">=</span><span class="st">&#39;localhost&#39;</span>, port<span class="op">=</span><span class="dv">6379</span>, db<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true"></a><span class="kw">def</span> get_user(user_id):</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true"></a>    <span class="co"># Try to get from cache</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true"></a>    cache_key <span class="op">=</span> <span class="ss">f&quot;user:</span><span class="sc">{</span>user_id<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true"></a>    cached_user <span class="op">=</span> redis_client.get(cache_key)</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true"></a>    </span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true"></a>    <span class="cf">if</span> cached_user:</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true"></a>        <span class="cf">return</span> json.loads(cached_user)</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true"></a>    </span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true"></a>    <span class="co"># If not in cache, get from database</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true"></a>    conn <span class="op">=</span> psycopg2.<span class="ex">connect</span>(</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true"></a>        host<span class="op">=</span><span class="st">&quot;localhost&quot;</span>,</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true"></a>        dbname<span class="op">=</span><span class="st">&quot;mydb&quot;</span>,</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true"></a>        user<span class="op">=</span><span class="st">&quot;app_user&quot;</span>,</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true"></a>        password<span class="op">=</span><span class="st">&quot;password&quot;</span></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true"></a>    )</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true"></a>    <span class="cf">try</span>:</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true"></a>        cur <span class="op">=</span> conn.cursor()</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true"></a>        cur.execute(<span class="st">&quot;SELECT id, name, email FROM users WHERE id = </span><span class="sc">%s</span><span class="st">&quot;</span>, (user_id,))</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true"></a>        user <span class="op">=</span> cur.fetchone()</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true"></a>        </span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true"></a>        <span class="cf">if</span> user:</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true"></a>            <span class="co"># Convert to dictionary</span></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true"></a>            user_dict <span class="op">=</span> {</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true"></a>                <span class="st">&quot;id&quot;</span>: user[<span class="dv">0</span>],</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true"></a>                <span class="st">&quot;name&quot;</span>: user[<span class="dv">1</span>],</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true"></a>                <span class="st">&quot;email&quot;</span>: user[<span class="dv">2</span>]</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true"></a>            }</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true"></a>            </span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true"></a>            <span class="co"># Store in cache (expire after 300 seconds)</span></span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true"></a>            redis_client.setex(cache_key, <span class="dv">300</span>, json.dumps(user_dict))</span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true"></a>            </span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true"></a>            <span class="cf">return</span> user_dict</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true"></a>        </span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true"></a>    <span class="cf">finally</span>:</span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true"></a>        conn.close()</span></code></pre>
        </div>
      </section>
      <section>
        <ol start="2" type="1">
          <li><strong>Database-Level Caching</strong>:</li>
        </ol>
        <div class="sourceCode" id="cb61">
          <pre
            class="sourceCode sql"><code class="sourceCode sql"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true"></a><span class="co">-- Create a materialized view for caching</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> product_sales_summary <span class="kw">AS</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true"></a><span class="kw">SELECT</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true"></a>    p.product_id,</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true"></a>    p.name <span class="kw">AS</span> product_name,</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true"></a>    <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> o.<span class="kw">id</span>) <span class="kw">AS</span> order_count,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true"></a>    <span class="fu">SUM</span>(oi.quantity) <span class="kw">AS</span> units_sold,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true"></a>    <span class="fu">SUM</span>(oi.quantity <span class="op">*</span> oi.price) <span class="kw">AS</span> revenue</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true"></a><span class="kw">FROM</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true"></a>    product p</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true"></a>    order_item oi <span class="kw">ON</span> p.product_id <span class="op">=</span> oi.product_id</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true"></a>    orders o <span class="kw">ON</span> oi.order_id <span class="op">=</span> o.<span class="kw">id</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true"></a><span class="kw">GROUP</span> <span class="kw">BY</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true"></a>    p.product_id, p.name;</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true"></a></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true"></a><span class="co">-- Create an index on the materialized view</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true"></a><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_product_sales_summary_revenue <span class="kw">ON</span> product_sales_summary(revenue <span class="kw">DESC</span>);</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true"></a><span class="co">-- Refresh the materialized view</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true"></a><span class="kw">REFRESH</span> <span class="kw">MATERIALIZED</span> <span class="kw">VIEW</span> product_sales_summary;</span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Connection Pooling with pgBouncer</strong>:</p>
        <div class="sourceCode" id="cb62">
          <pre
            class="sourceCode ini"><code class="sourceCode ini"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true"></a><span class="co"># pgbouncer.ini</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true"></a><span class="kw">[databases]</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true"></a><span class="dt">mydb </span><span class="ot">=</span><span class="st"> host=</span><span class="kw">localhost</span><span class="st"> port=</span><span class="dv">5432</span><span class="st"> dbname=mydb</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true"></a><span class="kw">[pgbouncer]</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true"></a><span class="dt">listen_addr </span><span class="ot">=</span><span class="st"> *</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true"></a><span class="dt">listen_port </span><span class="ot">=</span><span class="st"> </span><span class="dv">6432</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true"></a><span class="dt">auth_type </span><span class="ot">=</span><span class="st"> md5</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true"></a><span class="dt">auth_file </span><span class="ot">=</span><span class="st"> /etc/pgbouncer/userlist.txt</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true"></a><span class="dt">pool_mode </span><span class="ot">=</span><span class="st"> transaction</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true"></a><span class="dt">max_client_conn </span><span class="ot">=</span><span class="st"> </span><span class="dv">1000</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true"></a><span class="dt">default_pool_size </span><span class="ot">=</span><span class="st"> </span><span class="dv">20</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true"></a><span class="dt">min_pool_size </span><span class="ot">=</span><span class="st"> </span><span class="dv">5</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true"></a><span class="dt">reserve_pool_size </span><span class="ot">=</span><span class="st"> </span><span class="dv">5</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true"></a><span class="dt">reserve_pool_timeout </span><span class="ot">=</span><span class="st"> </span><span class="dv">3</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true"></a><span class="dt">max_db_connections </span><span class="ot">=</span><span class="st"> </span><span class="dv">50</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true"></a><span class="dt">max_user_connections </span><span class="ot">=</span><span class="st"> </span><span class="dv">50</span></span></code></pre>
        </div>
      </section>
      <section>
        <p><strong>Scaling Checklist</strong>:</p>
        <ol type="1">
          <li><strong>Before Scaling</strong>:
            <ul>
              <li>Optimize queries and indexes</li>
              <li>Tune PostgreSQL configuration</li>
              <li>Implement appropriate caching</li>
              <li>Consider connection pooling</li>
            </ul>
          </li>
          <li><strong>Vertical Scaling</strong>:
            <ul>
              <li>Upgrade hardware</li>
              <li>Tune memory parameters</li>
              <li>Optimize storage configuration</li>
              <li>Consider specialized hardware (e.g., RAID, NVMe)</li>
            </ul>
          </li>
          <li><strong>Horizontal Scaling</strong>:
            <ul>
              <li>Implement read replicas</li>
              <li>Set up load balancing</li>
              <li>Consider sharding for write scaling</li>
              <li>Implement proper monitoring</li>
            </ul>
          </li>
          <li><strong>Application Considerations</strong>:
            <ul>
              <li>Design for eventual consistency</li>
              <li>Implement retry logic</li>
              <li>Handle distributed transactions</li>
              <li>Consider microservices architecture</li>
            </ul>
          </li>
        </ol>
        <p>By understanding these advanced PostgreSQL features and best practices, product owners can make informed
          decisions about database architecture, maintenance, and scaling strategies to support their applications
          effectively.</p>
      </section>
    </div>
  </div> <!-- /container -->
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</html>